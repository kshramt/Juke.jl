#!/usr/bin/env julia

using Juke


function main(args)
    pargs = Juke.parse_args(args)
    JukeContext = Module()
    expr = quote
        using Juke
        const cd = Juke.cd
        const run = Juke.run
        const mv = Juke.mv
        const rm = Juke.rm
        const sh = Juke.sh

        const __juke_dsl__ = Juke.make_dsl()
        const finish = __juke_dsl__[1]
        const job = __juke_dsl__[2]
        const desc = __juke_dsl__[3]

        include($(joinpath(pwd(), pargs["file"])))
        finish(
            $(pargs["targets"]),
            $(pargs["keep-going"]),
            $(pargs["jobs"]),
            $(pargs["print-dependencies"]),
            $(pargs["descriptions"]),
        )
    end
    eval(JukeContext, expr)
end

if realpath(PROGRAM_FILE) == realpath(@__FILE__)
    main(ARGS)
end
